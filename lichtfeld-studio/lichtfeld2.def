Bootstrap: localimage
From: lichtfeld.sif

%files

%environment
    export LC_ALL=C

%post
    export CUDACXX=/usr/local/cuda/bin/nvcc
    export CUDA_PATH=/usr/local/cuda
    export CXX=/usr/bin/g++-14
    export CC=/usr/bin/gcc-14
    # Set up vcpkg (one-time setup)
    cd /opt
    git clone https://github.com/microsoft/vcpkg.git
    cd vcpkg && ./bootstrap-vcpkg.sh -disableMetrics

    ## If you want you can specify vcpkg locally without globally setting env variable (see -DCMAKE_TOOLCHAIN_FILE version)
    export VCPKG_ROOT=/opt/vcpkg  # Add to ~/.bashrc

    # Clone repository
    cd /opt
    git clone https://github.com/MrNeRF/LichtFeld-Studio
    cd LichtFeld-Studio

    # Download LibTorch 2.7.0 with CUDA 12.8
    wget https://download.pytorch.org/libtorch/cu128/libtorch-cxx11-abi-shared-with-deps-2.7.0%2Bcu128.zip
    unzip libtorch-cxx11-abi-shared-with-deps-2.7.0+cu128.zip -d external/
    rm libtorch-cxx11-abi-shared-with-deps-2.7.0+cu128.zip

    # Build
    # remove the Ninja build system, using the default, Unix Makefiles
    cmake -B build -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_CXX_COMPILER=/usr/bin/g++-14 -DCMAKE_C_COMPILER=/usr/bin/gcc-14

    ## Or if you want you can specify your own vcpkg
    # cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="<path-to-vcpkg>/scripts/buildsystems/vcpkg.cmake" -G Ninja

    # run make manually rather than using cmake
    cd build
    make -j 8

%labels
  author Jenny Fothergill <jennyfothergill@boisestate.edu>
  github.com/bsurc/container git rev={{GIT_REV}}
